name: deploy
on:
    push:
        branches:
            - master
    workflow_dispatch:

jobs:
    build:
        runs-on: ubuntu-latest
        timeout-minutes: 60
        steps:
            - name: checkout
              uses: actions/checkout@main

            - name: clear npm cache
              run: npm cache clean --force

            - name: setup volta
              uses: volta-cli/action@master

            - name: module install
              run: YARN_ENABLE_IMMUTABLE_INSTALLS=false yarn

            - name: build server
              run: NODE_OPTIONS="--max-old-space-size=4096" yarn build

            - name: deploy server
              uses: nogsantos/scp-deploy@master
              with:
                  src: ./.output/*
                  key: ${{ secrets.SSH_PRIVATEKEY }}
                  host: ${{ secrets.SSH_HOST }}
                  port: ${{ secrets.SSH_PORT }}
                  user: ${{ secrets.SSH_USERNAME }}
                  remote: ${{ secrets.SSH_REMOTE_SERVER }}

            - name: build client
              run: NODE_OPTIONS="--max-old-space-size=4096" yarn generate

            - name: deploy client
              uses: nogsantos/scp-deploy@master
              with:
                  src: ./.output/*
                  key: ${{ secrets.SSH_PRIVATEKEY }}
                  host: ${{ secrets.SSH_HOST }}
                  port: ${{ secrets.SSH_PORT }}
                  user: ${{ secrets.SSH_USERNAME }}
                  remote: ${{ secrets.SSH_REMOTE_CLIENT }}

            - name: deploy to Cloudflare
              uses: appleboy/ssh-action@master
              with:
                  key: ${{ secrets.SSH_PRIVATEKEY }}
                  host: ${{ secrets.SSH_HOST }}
                  port: ${{ secrets.SSH_PORT }}
                  username: ${{ secrets.SSH_USERNAME }}
                  script: |
                      cd ${{ secrets.SSH_REMOTE_SERVER }}
                      ~/.volta/bin/pm2 restart ${{ secrets.PM2_APP_NAME }} --update-env
                      cd ${{ secrets.SSH_REMOTE_CLIENT }}
                      npx wrangler pages deploy dist --project-name ktak-dev
